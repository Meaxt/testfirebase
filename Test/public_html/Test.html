<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <script src="https://cdn.firebase.com/js/client/2.2.4/firebase.js"></script>
        <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
        <link href="index.html">
    </head>
    <body>
        <div id="info"></div>
        <div id="input">
            <button id='login'>Logga in</button> 
        </div>
        <div id="chatruta"></div>

        <script>
            itsOn = 0;
            var ref = new Firebase('https://radiant-heat-57.firebaseio.com/');
            $('#login').click(function() {
                ref.authWithOAuthPopup("facebook", function(error, authData) {
                    if (error) {
                        console.log("Login Failed!", error);
                    } else {
                        itsOn = 1;
                        console.log("Authenticated successfully with payload:", authData);
                        username = authData.facebook.displayName;
                        removeStuff();
                        addStuff();
                    }
                });
                ref.onAuth(function(authData) {
                    if (authData) {
                        ref.child("users").child(authData.uid).set({
                            provider: authData.provider,
                            name: authData.facebook.displayName
                        });
                    }
                });
            });
            function addLogin() {
                $('#logindiv').append('<button id="login">Logga in</button>');
            }
            function addStuff() {
                $('#input').append('<input type="text" id="messageInput" placeholder="Message">');
                $('#input').append('<button id="logout">Logga ut</button>');
                addListeners();
            }
            function removeStuff() {
                $('#input').children().remove();
                $('#chatruta').children().empty();
            }
            function addListeners() {
                $('#logout').off("click");
                $('#logout').click(function() {
                    ref.unauth();
                    removeStuff();
                    addLogin();
                    itsOn = 0;
                });

                $('#messageInput').keypress(function(e) {
                    if (e.keyCode == 13) {
                        var text = $('#messageInput').val();
                        ref.child("chat").push('User ' + username + ' says ' + text);
                        $('#messageInput').val('');
                        $('#chatruta').append('User ' + username + ' says ' + text + '<br>');
                    }
                });
            }
            function authDataCallback(authData) {
                if (authData) {
//                    console.log("User " + authData.facebook.displayName + " is logged in with " + authData.provider);
                } else {
//                    console.log("User is logged out");
                }
            }

            ref.onAuth(authDataCallback);

        </script>
    </body>
</html>
